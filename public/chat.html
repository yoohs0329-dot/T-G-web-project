<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>T&G â€” ì±„íŒ…</title>
  <meta name="description" content="T&G ì±„íŒ…">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root{
      --bg-top:#eaf2ff; --bg-1:#f3f8fd; --bg-2:#ffffff;
      --ink:#111827; --ink-2:#334155; --muted:#6b7280;
      --brand:#106466; --brand-2:#0e7c86; --accent:#6D4DE6;
      --card:#ffffff;
      --line:rgba(17,24,39,.10); --line-2:rgba(17,24,39,.14);
      --shadow:0 2px 14px rgba(17,24,39,.06); --shadow-h:0 8px 28px rgba(17,24,39,.10);
      --focus:#6D4DE6;
      --radius:10px; --radius-lg:14px;
      --success:#16a34a;
      --bubble-me:#0e7c86; --bubble-you:#ffffff;
      --bubble-me-text:#ffffff; --bubble-you-text:#0b254b;
      --badge:#0ea5a5;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      font-family:"Pretendard","Noto Sans KR",ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background:
        radial-gradient(120% 90% at 50% -25%, rgba(0,53,128,.16), transparent 70%),
        linear-gradient(180deg, var(--bg-top) 0%, var(--bg-1) 35%, var(--bg-2) 100%);
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    :focus-visible{outline:3px solid var(--focus); outline-offset:2px; border-radius:8px}

    /* header */
    .hd{position:sticky; top:0; z-index:50; backdrop-filter: blur(6px); background:rgba(255,255,255,.92); border-bottom:1px solid var(--line)}
    .row{max-width:1180px; margin:0 auto; padding:14px 20px; display:flex; align-items:center; justify-content:space-between}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--ink-2); font-weight:900; letter-spacing:.2px}
    .brand img{height:36px; width:auto; filter:saturate(0.9) contrast(1.05)}
    .nav{display:flex; gap:10px; align-items:center}
    .nav a, .nav button{
      display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; border:1px solid var(--line);
      background:#fff; color:var(--ink-2); text-decoration:none; cursor:pointer; font-weight:800;
    }
    .nav a:hover, .nav button:hover{background:#f6f7fb}

    /* layout */
    .wrap{max-width:1180px; margin:22px auto 28px; padding:0 20px}
    .shell{ display:grid; grid-template-columns: 320px 1fr; gap:18px; min-height: calc(100vh - 140px); }
    @media(max-width:960px){ .shell{grid-template-columns:1fr} }

    /* sidebar */
    .side{ background:var(--card); border:1px solid var(--line-2); border-radius:14px; box-shadow:var(--shadow); overflow:hidden; display:flex; flex-direction:column; min-height:420px; }
    .side-head{display:flex; align-items:center; gap:10px; padding:12px; border-bottom:1px solid var(--line);}
    .side-head .search{flex:1; position:relative;}
    .side-head input{ width:100%; padding:10px 12px 10px 36px; border:1px solid var(--line); border-radius:10px; background:#fff; color:var(--ink); }
    .side-head i.fa-magnifying-glass{position:absolute; left:10px; top:50%; transform:translateY(-50%); color:var(--muted)}
    .filters{display:flex; gap:8px; padding:10px 12px; border-bottom:1px dashed var(--line)}
    .pill{ padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:#fff; color:var(--ink-2); font-weight:800; font-size:.86rem; cursor:pointer; }
    .pill.active{background:#eef2ff; border-color:#cfd7ff; color:#262a5f}
    .threads{flex:1; overflow:auto; padding:6px}
    .thread{ display:grid; grid-template-columns:48px 1fr auto; gap:10px; align-items:center; padding:8px 10px; border-radius:12px; cursor:pointer; border:1px solid transparent; }
    .thread:hover{background:#f7f9ff}
    .thread.active{background:#eef2ff; border-color:#cfd7ff}
    .avatar{width:48px; height:48px; border-radius:10px; object-fit:cover; border:1px solid var(--line)}
    .t-title{font-weight:900; color:var(--ink-2); display:flex; gap:6px; align-items:center}
    .online{width:8px; height:8px; border-radius:50%; background:var(--success); display:inline-block}
    .t-last{color:var(--muted); font-size:.9rem; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .t-meta{display:flex; flex-direction:column; align-items:flex-end; gap:6px}
    .time{color:var(--muted); font-size:.8rem}
    .unread{background:var(--badge); color:#fff; padding:2px 8px; border-radius:999px; font-size:.75rem; font-weight:900}

    /* chat panel */
    .chat{ background:var(--card); border:1px solid var(--line-2); border-radius:14px; box-shadow:var(--shadow);
      display:grid; grid-template-rows:auto 1fr auto; min-height:420px; overflow:hidden; }
    .chat-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 14px; border-bottom:1px solid var(--line);
      background:linear-gradient(180deg,#fff, #fafcff); }
    .peer{display:flex; align-items:center; gap:12px}
    .peer img{width:40px; height:40px; border-radius:10px; object-fit:cover; border:1px solid var(--line)}
    .peer .name{font-weight:900; color:var(--ink-2)}
    .peer .sub{font-size:.88rem; color:var(--muted)}
    .ch-actions{display:flex; gap:8px}
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; border:1px solid var(--line); background:#fff; cursor:pointer; font-weight:800; color:var(--ink-2) }
    .btn.primary{background:linear-gradient(180deg, var(--brand) 0%, var(--brand-2) 100%); color:#fff; border-color:transparent; box-shadow:0 10px 26px rgba(0,53,128,.18)}
    .btn:hover{background:#f6f7fb}
    .btn.primary:hover{filter:saturate(1.02) brightness(1.02)}

    .msgs{position:relative; overflow:auto; padding:18px; display:flex; flex-direction:column; gap:6px; background:linear-gradient(180deg,#fbfdff, #fff)}

    /* === ìì—°ìŠ¤ëŸ¬ìš´ ë©”ì‹œì§€ ë°°ì¹˜ === */
    .row{display:flex; gap:8px; align-items:flex-end}
    .row.me{justify-content:flex-end}
    .bubble{
      max-width:66%; margin:2px 0; padding:10px 14px;
      border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,.06);
      line-height:1.5; word-wrap:break-word; white-space:pre-wrap;
    }
    .row.you .bubble{background:var(--bubble-you); color:var(--bubble-you-text); border:1px solid var(--line); border-bottom-left-radius:6px}
    .row.me  .bubble{background:var(--bubble-me); color:var(--bubble-me-text); border:none; border-bottom-right-radius:6px}
    .row.cont .bubble{ margin-top:1px; }
    .row.you.cont .bubble{ border-top-left-radius:10px; }
    .row.me.cont  .bubble{ border-top-right-radius:10px; }

    .bubble .time-tag{ display:inline-block; margin-left:8px; font-size:.75rem; vertical-align:baseline; opacity:.7; }
    .row.me .bubble .time-tag{ color:rgba(255,255,255,.85); }
    .row.you .bubble .time-tag{ color:#6b7280; }

    .avatar-sm{width:28px; height:28px; border-radius:8px; object-fit:cover; border:1px solid var(--line)}
    .row.you .avatar-sm{ margin-right:6px; } /* ì•„ë°”íƒ€ê°€ ë²„ë¸” ì™¼ìª½ì— ë¶™ë„ë¡ */
    .row.you.cont .avatar-sm{ display:none; }

    .date-sep{ margin:6px 0; font-size:.82rem; opacity:.9; display:flex; align-items:center; gap:10px; color:var(--muted) }
    .date-sep::before,.date-sep::after{content:""; flex:1; height:1px; background:var(--line)}
    .meta-line{ display:none !important; }

    .attachment{margin-top:8px; border-radius:10px; overflow:hidden; border:1px solid var(--line); max-width:240px}
    .attachment img{display:block; width:100%; height:auto}

    .typing{display:flex; align-items:center; gap:6px; color:var(--muted); font-size:.9rem}
    .typing .dot{width:6px; height:6px; border-radius:50%; background:#c5cbd6; animation:b 1s infinite ease-in-out}
    .typing .dot:nth-child(2){animation-delay:.15s}
    .typing .dot:nth-child(3){animation-delay:.3s}
    @keyframes b{0%,80%,100%{opacity:.3; transform:translateY(0)}40%{opacity:1; transform:translateY(-2px)}}

    .composer{ border-top:1px solid var(--line); background:#fff; padding:10px; display:flex; gap:10px; align-items:flex-end; }
    .tools{display:flex; gap:6px}
    .icon-btn{ width:38px; height:38px; border:1px solid var(--line); border-radius:10px; background:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--ink-2) }
    .icon-btn:hover{background:#f6f7fb}
    .ta-wrap{flex:1; position:relative}
    .ta{ width:100%; min-height:42px; max-height:160px; padding:10px 12px; border:1px solid var(--line); border-radius:10px; resize:none; overflow:auto; font-size:1rem; line-height:1.45; outline:none; }
    .ta:focus{border-color:#cfd7ff; box-shadow:0 0 0 3px rgba(109,77,230,.12)}
    .send{ min-width:90px; height:42px; border:none; border-radius:10px; font-weight:900; letter-spacing:.2px; cursor:pointer;
      background:linear-gradient(180deg, var(--brand) 0%, var(--brand-2) 100%); color:#fff; box-shadow:0 10px 26px rgba(0,53,128,.18) }
    .send:disabled{opacity:.6; cursor:not-allowed; box-shadow:none}

    /* Floating: í™ˆ ë²„íŠ¼ë§Œ ìœ ì§€ */
    .floating-btn-group{position:fixed; right:22px; bottom:22px; display:flex; flex-direction:column; gap:12px; z-index:60}
    .floating-btn{
      background:#fff; border:1px solid var(--line); border-radius:50%; width:52px; height:52px;
      display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:var(--shadow);
      transition:transform .2s ease, background .2s ease
    }
    .floating-btn:hover{transform:translateY(-2px); background:#f1f5ff}
    /* === ê°•ì œ ì •ë ¬: ì´ˆë¡(ë‚´) ì˜¤ë¥¸ìª½ / í°ìƒ‰(ìƒëŒ€) ì™¼ìª½ === */
    /* === ì¢Œìš° â€˜ì«™â€™ ë¶™ëŠ” ë²„ë¸” ì •ë ¬ === */

/* ì±„íŒ… ì˜ì—­ ì¢Œìš° ì—¬ë°± ìµœì†Œí™” */
.msgs{
  padding-left: 10px;
  padding-right: 10px;
}

/* ê° ë©”ì‹œì§€ ì¤„ì´ ì „ì²´ í­ì„ ì°¨ì§€í•˜ë„ë¡ */
.msgs .row{
  display:flex; align-items:flex-end; width:100%;
  gap:8px;            /* ì•„ë°”íƒ€-ë²„ë¸” ê°„ê²©ë§Œ ë‚¨ê¹€ */
  margin-top:6px;
}

/* ìƒëŒ€(í°ìƒ‰) = ì™¼ìª½, ë‚´ ë©”ì‹œì§€(ì´ˆë¡) = ì˜¤ë¥¸ìª½ */
.msgs .row.you{ justify-content:flex-start; padding-left: 2px; } /* ê±°ì˜ ì™¼ìª½ì— ë¶™ìŒ */
.msgs .row.me { justify-content:flex-end;   padding-right:2px; } /* ê±°ì˜ ì˜¤ë¥¸ìª½ì— ë¶™ìŒ */

/* ë²„ë¸” ìµœëŒ€ë„ˆë¹„ â†‘ (ê¸´ ë¬¸ì¥ë„ ë³´ê¸° ì¢‹ê²Œ) */
.msgs .bubble{ max-width: 78%; }

/* ìƒëŒ€ ë©”ì‹œì§€: ì•„ë°”íƒ€ê°€ ë²„ë¸” ì™¼ìª½ì— ë¶™ë„ë¡ */
.msgs .row.you .avatar-sm{ order:0; margin:0 6px 0 0; }
.msgs .row.you .bubble{ order:1; margin-left:0; }

/* ë‚´ ë©”ì‹œì§€: ë²„ë¸”ì„ ì˜¤ë¥¸ìª½ ëê¹Œì§€ */
.msgs .row.me .bubble{ margin-right:0; }

/* ì—°ì† ë©”ì‹œì§€ëŠ” ì•„ë°”íƒ€ ìƒëµ + ìƒë‹¨ ë¼ìš´ë”©/ê°„ê²© ì¶•ì†Œ */
.msgs .row.cont .bubble{ margin-top:0; }
.msgs .row.you .bubble{ border-bottom-left-radius:6px; border-top-left-radius:16px; }
.msgs .row.me  .bubble{ border-bottom-right-radius:6px; border-top-right-radius:16px; }
.msgs .row.you.cont .bubble{ border-top-left-radius:10px; }
.msgs .row.me.cont  .bubble{ border-top-right-radius:10px; }

/* ë²„ë¸” ë‚´ë¶€ ì‹œê°„í‘œì‹œ(ì‘ê²Œ, ìš°ì¸¡ í•˜ë‹¨) */
.msgs .bubble .time-tag{ margin-left:8px; font-size:.74rem; opacity:.7; }
.msgs .row.me .bubble .time-tag{ color:rgba(255,255,255,.85); }
.msgs .row.you .bubble .time-tag{ color:#6b7280; }


  </style>
</head>
<body>
  <!-- header -->
  <header class="hd">
    <div class="row">
      <a href="index.html" class="brand" aria-label="T&G í™ˆ">
        <img src="images/logo.png" alt="T&G ë¡œê³ " onerror="this.onerror=null;this.src=window.__PLH__;">
        <span>T&G</span>
      </a>
      <nav class="nav" aria-label="ì±„íŒ… ë©”ë‰´">
        <a href="after_login.html"><i class="fa-solid fa-grid-2"></i> ëŒ€ì‹œë³´ë“œ</a>
        <a href="guide_index.html"><i class="fa-solid fa-user-group"></i> Local mate</a>
        <button type="button" id="newChatBtn"><i class="fa-solid fa-message-plus"></i> ìƒˆ ëŒ€í™”</button>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section class="shell" aria-label="ì±„íŒ… í™”ë©´">
      <!-- sidebar -->
      <aside class="side" aria-label="ëŒ€í™” ëª©ë¡">
        <div class="side-head">
          <div class="search">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input id="searchInput" type="search" placeholder="ìƒëŒ€/ì—¬í–‰ì§€ ê²€ìƒ‰â€¦" aria-label="ëŒ€í™” ê²€ìƒ‰" />
          </div>
        </div>
        <div class="filters" role="tablist" aria-label="í•„í„°">
          <button class="pill active" data-filter="all" role="tab" aria-selected="true">ì „ì²´</button>
          <button class="pill" data-filter="unread" role="tab" aria-selected="false">ì•ˆì½ìŒ</button>
          <button class="pill" data-filter="bookings" role="tab" aria-selected="false">ì˜ˆì•½</button>
        </div>
        <div id="threadList" class="threads"></div>
      </aside>

      <!-- chat panel -->
      <section class="chat" aria-live="polite">
        <header class="chat-head">
          <div class="peer">
            <img id="peerAvatar" src="" alt="ìƒëŒ€ í”„ë¡œí•„">
            <div>
              <div class="name" id="peerName">â€”</div>
              <div class="sub" id="peerSub">ì˜¤í”„ë¼ì¸</div>
            </div>
          </div>
          <div class="ch-actions">
            <button class="btn" id="muteBtn"><i class="fa-solid fa-bell-slash"></i> ì•Œë¦¼ ë„ê¸°</button>
            <button class="btn" id="reportBtn"><i class="fa-solid fa-flag"></i> ì‹ ê³ </button>
            <button class="btn primary" id="requestBtn"><i class="fa-solid fa-calendar-check"></i> ì˜ˆì•½ìš”ì²­</button>
          </div>
        </header>

        <div id="msgArea" class="msgs"></div>

        <form id="composer" class="composer" autocomplete="off">
          <div class="tools">
            <label class="icon-btn" title="ì´ë¯¸ì§€ ì²¨ë¶€">
              <input id="fileInput" type="file" accept="image/*" hidden>
              <i class="fa-regular fa-image"></i>
            </label>
            <button class="icon-btn" type="button" id="emojiBtn" title="ì´ëª¨ì§€"><i class="fa-regular fa-face-smile"></i></button>
          </div>
          <div class="ta-wrap">
            <textarea id="ta" class="ta" rows="1" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” " aria-label="ë©”ì‹œì§€ ì…ë ¥"></textarea>
          </div>
          <button class="send" id="sendBtn" type="submit" disabled><i class="fa-solid fa-paper-plane"></i> ì „ì†¡</button>
        </form>
      </section>
    </section>
  </main>

  <!-- Floating: í™ˆ ë²„íŠ¼ë§Œ -->
  <div class="floating-btn-group" aria-label="ë¹ ë¥¸ ì´ë™">
    <button class="floating-btn" onclick="location.href='index.html'" title="Home"><i class="fa-solid fa-house"></i></button>
  </div>

  <script>
    // placeholder image
    window.__PLH__ = 'data:image/svg+xml;utf8,' + encodeURIComponent(
      '<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="900"><rect width="100%" height="100%" fill="#e9eef5"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#94a3b8" font-size="28" font-family="Arial">ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</text></svg>'
    );

    const STORE_KEY = 'tg_chat_threads_v2';
    const sampleThreads = [
      {
        id:'seoul-night',
        name:'ì„œìš¸ ì•¼ê²½ íˆ¬ì–´',
        sub:'ë³´í†µ 1ì‹œê°„ ë‚´ ì‘ë‹µ Â· ì˜¨ë¼ì¸',
        photo:'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=600&q=80',
        unread:2, booking:false, online:true,
        messages:[
          {from:'you', text:'ì•ˆë…•í•˜ì„¸ìš”! ì„œìš¸ ì•¼ê²½ íˆ¬ì–´ì— ê´€ì‹¬ ê°€ì ¸ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.', ts:Date.now()-1000*60*60*24},
          {from:'me', text:'ì•ˆë…•í•˜ì„¸ìš”! íˆ¬ì–´ ì¼ì •ì´ ê¶ê¸ˆí•©ë‹ˆë‹¤.', ts:Date.now()-1000*60*60*23.5},
          {from:'you', text:'ë§¤ì£¼ í† ìš”ì¼ ì €ë… 7ì‹œì…ë‹ˆë‹¤. ë” ê¶ê¸ˆí•œ ì  ìˆìœ¼ì‹ ê°€ìš”?', ts:Date.now()-1000*60*60*23.4, read:true}
        ]
      },
      {
        id:'bike-hanriver',
        name:'ì„œìš¸ Â· í•œê°• ìì „ê±°',
        sub:'ë§ˆì§€ë§‰ ì ‘ì† 10ë¶„ ì „',
        photo:'images/í•œê°•ìì „ê±°.jpg',
        unread:0, booking:true, online:false,
        messages:[
          {from:'you', text:'ëŒ€ì—¬ í¬í•¨, ì•ˆì „ëª¨ í•„ìˆ˜ì…ë‹ˆë‹¤.', ts:Date.now()-1000*60*60*5},
          {from:'me', text:'ë§Œ 2ëª… ì˜ˆì•½í•˜ë ¤ë©´ ë¹„ìš©ì´?', ts:Date.now()-1000*60*60*4.9},
          {from:'you', text:'1ì¸ â‚©30,000ì…ë‹ˆë‹¤ ğŸ™Œ', ts:Date.now()-1000*60*60*4.8, read:true}
        ]
      },
      {
        id:'busan-beach',
        name:'ë¶€ì‚° í•´ë³€ ì‚°ì±…',
        sub:'ì˜¤ëŠ˜ 14:20 ì‘ë‹µ',
        photo:'https://images.unsplash.com/photo-1464983953574-0892a716854b?auto=format&fit=crop&w=600&q=80',
        unread:0, booking:false, online:true,
        messages:[
          {from:'you', text:'ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?', ts:Date.now()-1000*60*30}
        ]
      }
    ];

    const state = { threads: loadThreads(), activeId: null, filter:'all', search:'' };

    function loadThreads(){
      try{ const raw = localStorage.getItem(STORE_KEY); return raw ? JSON.parse(raw) : sampleThreads; }
      catch{ return sampleThreads }
    }
    function saveThreads(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(state.threads)); }catch{} }

    const qs = (s,el=document)=>el.querySelector(s);
    const qsa = (s,el=document)=>Array.from(el.querySelectorAll(s));
    const escapeHTML = (s)=>s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    const fmtTime = (ts)=>{ const d=new Date(ts); return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'); };
    const sameDay=(a,b)=>{const da=new Date(a),db=new Date(b);return da.getFullYear()===db.getFullYear()&&da.getMonth()===db.getMonth()&&da.getDate()===db.getDate();};
    const fmtDate=(ts)=>{ const d=new Date(ts); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };

    function renderThreads(){
      const wrap = qs('#threadList'); wrap.innerHTML='';
      const filtered = state.threads.filter(t=>{
        const f = (state.filter==='all') || (state.filter==='unread'&&t.unread>0) || (state.filter==='bookings'&&t.booking);
        const s = t.name.toLowerCase().includes(state.search) || (t.sub||'').toLowerCase().includes(state.search);
        return f && s;
      });

      filtered.forEach(t=>{
        const li = document.createElement('div');
        li.className='thread'+(t.id===state.activeId?' active':'');
        li.setAttribute('role','button');
        li.setAttribute('aria-label', `${t.name} ëŒ€í™” ì—´ê¸°`);
        li.innerHTML = `
          <img class="avatar" src="${t.photo}" alt="${t.name}" onerror="this.onerror=null;this.src=window.__PLH__;">
          <div>
            <div class="t-title">${t.online?'<span class="online" title="ì˜¨ë¼ì¸"></span>':''}<span>${escapeHTML(t.name)}</span></div>
            <div class="t-last">${escapeHTML((t.messages[t.messages.length-1]||{}).text||'ìƒˆ ëŒ€í™” ì‹œì‘í•˜ê¸°')}</div>
          </div>
          <div class="t-meta">
            <div class="time">${t.messages.length?fmtTime(t.messages[t.messages.length-1].ts):''}</div>
            ${t.unread?`<div class="unread" aria-label="ì•ˆì½ì€ ë©”ì‹œì§€ ${t.unread}ê°œ">${t.unread}</div>`:''}
          </div>
        `;
        li.addEventListener('click',()=>openThread(t.id));
        wrap.appendChild(li);
      });

      if(!state.activeId && filtered.length){ state.activeId = filtered[0].id; }
      updatePeerHeader();
      renderMessages();
    }

    function updatePeerHeader(){
      const t = state.threads.find(x=>x.id===state.activeId);
      if(!t){ qs('#peerName').textContent='â€”'; qs('#peerSub').textContent=''; qs('#peerAvatar').src=window.__PLH__; return; }
      qs('#peerName').textContent = t.name;
      qs('#peerSub').textContent  = t.sub || (t.online?'ì˜¨ë¼ì¸':'ì˜¤í”„ë¼ì¸');
      qs('#peerAvatar').src = t.photo;
      qs('#peerAvatar').onerror = function(){ this.onerror=null; this.src = window.__PLH__; };
    }

    // ìì—°ìŠ¤ëŸ¬ìš´ ë©”ì‹œì§€ ë Œë”ë§(ì•„ë°”íƒ€ ì™¼ìª½ ë¶€ì°©)
    function renderMessages(){
      const area = document.getElementById('msgArea'); area.innerHTML='';
      const t = state.threads.find(x=>x.id===state.activeId);
      if(!t){ return; }

      let lastTs = 0;
      for(let i=0;i<t.messages.length;i++){
        const m = t.messages[i];
        const prev = t.messages[i-1];
        const grouped = prev && prev.from===m.from && (m.ts - prev.ts) <= 5*60*1000;

        if(!sameDay(m.ts, lastTs)){
          const sep = document.createElement('div');
          sep.className='date-sep';
          sep.textContent = fmtDate(m.ts);
          area.appendChild(sep);
        }

        const row = document.createElement('div');
        row.className = 'row ' + (m.from==='me'?'me':'you') + (grouped?' cont':'');

        // ìƒëŒ€ ë©”ì‹œì§€: ì•„ë°”íƒ€ë¥¼ ì™¼ìª½ì— ë¨¼ì € ë°°ì¹˜
        if(m.from==='you' && !grouped){
          const av = document.createElement('img');
          av.className='avatar-sm';
          av.src = t.photo; av.alt = t.name;
          av.onerror=function(){ this.onerror=null; this.src=window.__PLH__; };
          row.appendChild(av);
        }

        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.innerHTML = escapeHTML(m.text || '');

        if(m.image){
          const at = document.createElement('div');
          at.className='attachment';
          const img = document.createElement('img');
          img.src = m.image; img.alt = 'ì²¨ë¶€ ì´ë¯¸ì§€';
          at.appendChild(img);
          bubble.appendChild(at);
        }

        const time = document.createElement('span');
        time.className = 'time-tag';
        time.textContent = fmtTime(m.ts);
        bubble.appendChild(time);

        row.appendChild(bubble);
        area.appendChild(row);

        lastTs = m.ts;
      }

      t.unread = 0; saveThreads();
      area.scrollTop = area.scrollHeight;
    }

    function openThread(id){ state.activeId = id; renderThreads(); }

    qsa('.pill').forEach(p=>{
      p.addEventListener('click',()=>{
        qsa('.pill').forEach(x=>x.classList.remove('active'));
        p.classList.add('active');
        state.filter = p.dataset.filter;
        renderThreads();
      })
    });

    qs('#searchInput').addEventListener('input', (e)=>{
      state.search = (e.target.value||'').trim().toLowerCase();
      renderThreads();
    });

    qs('#newChatBtn').addEventListener('click', ()=>{
      const id = 'new-'+Date.now();
      state.threads.unshift({ id, name:'ìƒˆ ëŒ€í™”', sub:'', photo:window.__PLH__, unread:0, booking:false, online:false, messages:[] });
      state.activeId = id; saveThreads(); renderThreads(); qs('#ta').focus();
    });

    const ta = qs('#ta'), sendBtn = qs('#sendBtn'), composer = qs('#composer');

    ta.addEventListener('input', ()=>{
      sendBtn.disabled = !ta.value.trim();
      ta.style.height='auto';
      ta.style.height=Math.min(160, ta.scrollHeight)+'px';
    });
    ta.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); if(!sendBtn.disabled) composer.requestSubmit(); }
    });
    composer.addEventListener('submit', (e)=>{
      e.preventDefault();
      const text = ta.value.trim(); if(!text) return;
      pushMessage({text}); ta.value=''; ta.dispatchEvent(new Event('input'));
    });

    function pushMessage({text,image}){
      const t = state.threads.find(x=>x.id===state.activeId);
      if(!t) return;
      const now = Date.now();
      t.messages.push({from:'me', text, image, ts:now, read:false});
      saveThreads(); renderMessages();

      showTyping();
      setTimeout(()=>{
        hideTyping();
        const reply = autoReply(text);
        t.messages.push({from:'you', text:reply, ts:Date.now()});
        const lastMe = t.messages.slice().reverse().find(m=>m.from==='me' && !m.read);
        if(lastMe) lastMe.read = true;
        t.unread = 0; saveThreads(); renderMessages();
      }, 900 + Math.random()*800);
    }

    qs('#fileInput').addEventListener('change', (e)=>{
      const file = e.target.files && e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{ pushMessage({text:'', image: reader.result}); };
      reader.readAsDataURL(file); e.target.value='';
    });

    qs('#emojiBtn').addEventListener('click', ()=>{
      const emojis = ['ğŸ˜Š','ğŸ™Œ','ğŸ‘','ğŸ‰','ğŸ“','ğŸ•’','ğŸ“·','ğŸš²','ğŸœ','âœˆï¸'];
      const pick = emojis[Math.floor(Math.random()*emojis.length)];
      const s = ta.selectionStart, e = ta.selectionEnd;
      ta.value = ta.value.slice(0,s) + pick + ta.value.slice(e);
      ta.focus(); ta.setSelectionRange(s+pick.length, s+pick.length);
      ta.dispatchEvent(new Event('input'));
    });

    let typingEl;
    function showTyping(){
      const area = qs('#msgArea'); hideTyping();
      typingEl = document.createElement('div');
      typingEl.className='typing';
      typingEl.innerHTML = `<span class="dot"></span><span class="dot"></span><span class="dot"></span> ì…ë ¥ ì¤‘â€¦`;
      area.appendChild(typingEl); area.scrollTop = area.scrollHeight;
    }
    function hideTyping(){ if(typingEl && typingEl.parentNode) typingEl.parentNode.removeChild(typingEl); typingEl=null; }

    function autoReply(text){
      text = text.toLowerCase();
      if(text.includes('ê°€ê²©')||text.includes('ë¹„ìš©')) return '1ì¸ ê¸°ì¤€ ê°€ê²©ì„ ì•ˆë‚´ë“œë ¸ì–´ìš”. ì¸ì›ì— ë”°ë¼ í• ì¸ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
      if(text.includes('ì˜ˆì•½')) return 'ê°€ëŠ¥í•œ ë‚ ì§œë¥¼ ì•Œë ¤ì£¼ì‹œë©´ ì˜ˆì•½ ë„ì™€ë“œë¦´ê²Œìš”!';
      if(text.includes('ìœ„ì¹˜')||text.includes('ë§Œë‚˜ëŠ”')) return 'ë§Œë‚¨ ì¥ì†ŒëŠ” 2í˜¸ì„  ì‹œì²­ì—­ 3ë²ˆ ì¶œêµ¬ ì•ì…ë‹ˆë‹¤.';
      return 'ë„¤, í™•ì¸í–ˆìŠµë‹ˆë‹¤. ë” ë„ì™€ë“œë¦´ ë‚´ìš©ì´ ìˆì„ê¹Œìš”?';
    }

    qs('#muteBtn').addEventListener('click', ()=>alert('ì•Œë¦¼ì´ êº¼ì¡ŒìŠµë‹ˆë‹¤(ë°ëª¨).'));
    qs('#reportBtn').addEventListener('click', ()=>confirm('í•´ë‹¹ ì‚¬ìš©ìë¥¼ ì‹ ê³ í•˜ì‹œê² ì–´ìš”? (ë°ëª¨)') && alert('ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤(ë°ëª¨).'));
    qs('#requestBtn').addEventListener('click', ()=>alert('ì˜ˆì•½ ìš”ì²­ í”Œë¡œìš°ë¡œ ì´ë™í•©ë‹ˆë‹¤(ë°ëª¨).'));

    (function init(){
      const url = new URL(location.href);
      const tid = url.searchParams.get('t');
      if(tid && state.threads.some(t=>t.id===tid)) state.activeId=tid;
      renderThreads();
    })();
  </script>
</body>
</html>
