<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>T&G 로그인 / 회원가입</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body{margin:0;background:#f0f6fb;font-family:Segoe UI, Arial}
    .wrap{max-width:460px;margin:60px auto;background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:26px 22px}
    h1{margin:6px 0 18px;color:#003580}
    .tabs{display:flex;gap:8px;margin-bottom:16px}
    .tabs button{flex:1;padding:10px;border:1px solid #e0e6ed;border-radius:10px;background:#fff;cursor:pointer}
    .tabs button.active{background:#003580;color:#fff}
    .f{display:grid;gap:10px}
    .row{display:grid;gap:6px}
    label{font-size:.95rem;color:#003580}
    input,select{padding:10px 12px;border:1px solid #e0e6ed;border-radius:8px;font-size:1rem}
    .pw-box{position:relative}
    .toggle{position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;color:#888}
    .btn{padding:12px;border:none;border-radius:10px;background:#ffb700;color:#003580;font-weight:bold;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .msg{min-height:18px;color:#e74c3c}
    .ok{color:#1abc9c}
    .hint{font-size:.9rem;color:#666}
    .flex{display:flex;gap:8px;align-items:center}
    .link{margin-top:12px;text-align:center}
    a{color:#003580;text-decoration:none}
    .meter{height:8px;border-radius:6px;background:#eef2f8;overflow:hidden}
    .meter > div{height:100%;width:0%;background:#e74c3c;transition:width .25s}
    .meter.good > div{background:#ffb700}
    .meter.strong > div{background:#1abc9c}
    .small{font-size:.9rem;color:#666}
  </style>
</head>
<body>
  <div class="wrap">
    <h1><i class="fa-solid fa-user-shield"></i> 로그인 / 회원가입</h1>

    <div class="tabs">
      <button id="tab-login" class="active">로그인</button>
      <button id="tab-signup">회원가입</button>
    </div>

    <!-- 로그인 -->
    <div id="login-pane">
      <div class="f">
        <div class="row">
          <label for="login-email">이메일</label>
          <input id="login-email" type="email" placeholder="you@example.com" autocomplete="email" />
        </div>
        <div class="row">
          <label for="login-password">비밀번호</label>
          <div class="pw-box">
            <input id="login-password" type="password" placeholder="비밀번호" autocomplete="current-password"/>
            <i class="fa-regular fa-eye toggle" data-target="login-password"></i>
          </div>
        </div>
        <div class="flex">
          <input id="login-remember" type="checkbox" />
          <label for="login-remember" class="small">자동 로그인(이 브라우저에서 30일 유지)</label>
        </div>
        <button id="login-btn" class="btn" onclick="login()">로그인</button>
        <div id="login-msg" class="msg"></div>
      </div>
    </div>

    <!-- 회원가입 -->
    <div id="signup-pane" style="display:none">
      <div class="f">
        <div class="row">
          <label for="sign-name">이름</label>
          <input id="sign-name" type="text" placeholder="2~30자" autocomplete="name"/>
        </div>
        <div class="row">
          <label for="sign-email">이메일</label>
          <input id="sign-email" type="email" placeholder="you@example.com" autocomplete="email"/>
          <div id="email-hint" class="hint"></div>
        </div>
        <div class="row">
          <label for="sign-password">비밀번호</label>
          <div class="pw-box">
            <input id="sign-password" type="password" placeholder="대/소문자·숫자·특수문자 포함, 8~72자" autocomplete="new-password"/>
            <i class="fa-regular fa-eye toggle" data-target="sign-password"></i>
          </div>
          <div class="meter" id="pw-meter"><div></div></div>
          <div id="pw-hint" class="hint">영문 대/소문자, 숫자, 특수문자를 포함해 8자 이상 입력하세요.</div>
        </div>
        <div class="row">
          <label for="sign-role">역할</label>
          <select id="sign-role">
            <option value="traveler">Traveler</option>
            <option value="guide">Guide</option>
          </select>
        </div>
        <div class="flex">
          <input id="sign-remember" type="checkbox" />
          <label for="sign-remember" class="small">자동 로그인(이 브라우저에서 30일 유지)</label>
        </div>
        <div class="flex">
          <input id="sign-agree" type="checkbox" />
          <label for="sign-agree" class="small">이용약관 및 개인정보 처리방침에 동의합니다.</label>
        </div>
        <button id="sign-btn" class="btn" onclick="signup()">회원가입</button>
        <div id="sign-msg" class="msg"></div>
      </div>
    </div>

    <div class="link"><a href="index.html">← 홈으로</a></div>
  </div>

  <script>
    // 탭 전환
    const tabLogin = document.getElementById('tab-login');
    const tabSignup = document.getElementById('tab-signup');
    const loginPane = document.getElementById('login-pane');
    const signupPane = document.getElementById('signup-pane');

    tabLogin.onclick = () => {
      tabLogin.classList.add('active'); tabSignup.classList.remove('active');
      loginPane.style.display = ''; signupPane.style.display = 'none';
    };
    tabSignup.onclick = () => {
      tabSignup.classList.add('active'); tabLogin.classList.remove('active');
      signupPane.style.display = ''; loginPane.style.display = 'none';
    };

    // 비밀번호 보기/숨기기
    document.querySelectorAll('.toggle').forEach(t => {
      t.addEventListener('click', () => {
        const id = t.getAttribute('data-target');
        const inp = document.getElementById(id);
        if (inp.type === 'password') { inp.type = 'text'; t.classList.replace('fa-eye','fa-eye-slash'); }
        else { inp.type = 'password'; t.classList.replace('fa-eye-slash','fa-eye'); }
      });
    });

    // 디바운스
    function debounce(fn, ms=400){ let h; return (...a)=>{ clearTimeout(h); h=setTimeout(()=>fn(...a), ms); }; }

    // 이메일 실시간 확인
    const emailInput = document.getElementById('sign-email');
    const emailHint = document.getElementById('email-hint');
    emailInput.addEventListener('input', debounce(async ()=>{
      const email = emailInput.value.trim();
      emailHint.textContent = '';
      if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { emailHint.textContent = '유효한 이메일 형식을 입력하세요.'; return; }
      try{
        const res = await fetch(`/api/auth/check-email?email=${encodeURIComponent(email)}`);
        const data = await res.json();
        if(data.available){ emailHint.textContent = '사용 가능한 이메일입니다.'; emailHint.className = 'hint ok'; }
        else { emailHint.textContent = '이미 사용 중인 이메일입니다.'; emailHint.className = 'hint'; }
      }catch{ /* 무시 */ }
    }, 500));

    // 비밀번호 강도/정책
    const pwInput = document.getElementById('sign-password');
    const pwHint = document.getElementById('pw-hint');
    const pwMeter = document.getElementById('pw-meter');
    pwInput.addEventListener('input', ()=>{
      const v = pwInput.value;
      const rules = [
        /[A-Z]/.test(v),     // 대문자
        /[a-z]/.test(v),     // 소문자
        /[0-9]/.test(v),     // 숫자
        /[^A-Za-z0-9]/.test(v), // 특수문자
        v.length >= 8
      ];
      const score = rules.filter(Boolean).length;
      const w = Math.min(100, score * 20);
      pwMeter.querySelector('div').style.width = w + '%';
      pwMeter.classList.remove('good','strong');
      if(score >= 3) pwMeter.classList.add('good');
      if(score >= 4) pwMeter.classList.add('strong');
      pwHint.textContent = score >= 4 ? '좋습니다! 안전한 비밀번호예요.' : '대/소문자·숫자·특수문자 포함, 8자 이상을 권장합니다.';
    });

    // 버튼 로딩/비활성 유틸
    function setLoading(btn, loading){
      btn.disabled = loading;
      btn.textContent = loading ? '처리 중...' : btn.dataset.label || btn.textContent;
    }

    async function login(){
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      const remember = document.getElementById('login-remember').checked;
      const msg = document.getElementById('login-msg');
      const btn = document.getElementById('login-btn');
      btn.dataset.label = '로그인';
      msg.textContent = ''; setLoading(btn, true);
      try{
        const res = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ email, password, remember })
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.error || '로그인 실패');
        location.href = 'index.html';
      }catch(e){ msg.textContent = e.message; }
      finally{ setLoading(btn, false); }
    }

    async function signup(){
      const name = document.getElementById('sign-name').value.trim();
      const email = document.getElementById('sign-email').value.trim().toLowerCase();
      const password = document.getElementById('sign-password').value;
      const role = document.getElementById('sign-role').value;
      const remember = document.getElementById('sign-remember').checked;
      const agree = document.getElementById('sign-agree').checked;
      const msg = document.getElementById('sign-msg');
      const btn = document.getElementById('sign-btn');
      btn.dataset.label = '회원가입';
      msg.textContent = ''; setLoading(btn, true);

      // 클라이언트 측 1차 체크 (서버도 다시 검사함)
      if(name.length < 2){ msg.textContent = '이름은 2자 이상 입력하세요.'; setLoading(btn, false); return; }
      if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ msg.textContent = '유효한 이메일을 입력하세요.'; setLoading(btn, false); return; }
      const policyOk = /[A-Z]/.test(password) && /[a-z]/.test(password) && /[0-9]/.test(password) && /[^A-Za-z0-9]/.test(password) && password.length>=8;
      if(!policyOk){ msg.textContent = '비밀번호 정책을 충족하지 않습니다.'; setLoading(btn, false); return; }
      if(!agree){ msg.textContent = '약관에 동의해야 가입할 수 있습니다.'; setLoading(btn, false); return; }

      try{
        const res = await fetch('/api/auth/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ name, email, password, role, remember, agree })
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.error || (data.details && data.details[0]) || '가입 실패');
        location.href = 'index.html';
      }catch(e){ msg.textContent = e.message; }
      finally{ setLoading(btn, false); }
    }
  </script>
</body>
</html>